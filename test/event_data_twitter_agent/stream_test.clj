(ns event-data-twitter-agent.stream-test
  (:require [clojure.test :refer :all]
            [event-data-twitter-agent.stream :as stream]))

(def input-sample "{\"id\":\"tag:search.twitter.com,2005:740507302185336832\",\"objectType\":\"activity\",\"actor\":{\"objectType\":\"person\",\"id\":\"id:twitter.com:267252690\",\"link\":\"http://www.twitter.com/michaelkinder\",\"displayName\":\"Michael Kinder\",\"postedTime\":\"2011-03-16T15:56:25.000Z\",\"image\":\"https://pbs.twimg.com/profile_images/1572771556/me_normal.jpg\",\"summary\":\"Environmental Safety & Health and Public Health professional with additional specialty in IT & Data Management. Strive to inform public of data: Good or bad!\",\"links\":[{\"href\":\"http://michaelskinder.com\",\"rel\":\"me\"}],\"friendsCount\":209,\"followersCount\":285,\"listedCount\":159,\"statusesCount\":26236,\"twitterTimeZone\":\"Eastern Time (US & Canada)\",\"verified\":false,\"utcOffset\":\"-14400\",\"preferredUsername\":\"michaelkinder\",\"languages\":[\"en\"],\"location\":{\"objectType\":\"place\",\"displayName\":\"Cleveland, OH\"},\"favoritesCount\":3},\"verb\":\"share\",\"postedTime\":\"2016-06-08T11:34:33.000Z\",\"generator\":{\"displayName\":\"RoundTeam\",\"link\":\"https://roundteam.co\"},\"provider\":{\"objectType\":\"service\",\"displayName\":\"Twitter\",\"link\":\"http://www.twitter.com\"},\"link\":\"http://twitter.com/michaelkinder/statuses/740507302185336832\",\"body\":\"RT @NPPTL: Ponerse y Quitarse Adecuadamente un #Respirador Desechable https://t.co/WFnvmG7mN6 NIOSH Pub 2010-133sp How to don and doff\",\"object\":{\"id\":\"tag:search.twitter.com,2005:740506753335451648\",\"objectType\":\"activity\",\"actor\":{\"objectType\":\"person\",\"id\":\"id:twitter.com:18139029\",\"link\":\"http://www.twitter.com/NPPTL\",\"displayName\":\"ProtectiveTechnology\",\"postedTime\":\"2008-12-15T16:00:51.000Z\",\"image\":\"https://pbs.twimg.com/profile_images/601385338343464961/Re6qu5qY_normal.jpg\",\"summary\":\"The National Personal Protective Technology Laboratory, part of @NIOSH and @CDCgov (our RT, listing or following does not mean endorsement)  *Burgh Verified*\",\"links\":[{\"href\":\"http://www.cdc.gov/niosh/npptl/\",\"rel\":\"me\"}],\"friendsCount\":1497,\"followersCount\":8280,\"listedCount\":296,\"statusesCount\":7324,\"twitterTimeZone\":\"Eastern Time (US & Canada)\",\"verified\":true,\"utcOffset\":\"-14400\",\"preferredUsername\":\"NPPTL\",\"languages\":[\"en\"],\"location\":{\"objectType\":\"place\",\"displayName\":\"Pittsburgh, Pennsylvania 15236\"},\"favoritesCount\":15},\"verb\":\"post\",\"postedTime\":\"2016-06-08T11:32:22.000Z\",\"generator\":{\"displayName\":\"Mobile Web (M2)\",\"link\":\"https://mobile.twitter.com\"},\"provider\":{\"objectType\":\"service\",\"displayName\":\"Twitter\",\"link\":\"http://www.twitter.com\"},\"link\":\"http://twitter.com/NPPTL/statuses/740506753335451648\",\"body\":\"Ponerse y Quitarse Adecuadamente un #Respirador Desechable https://t.co/WFnvmG7mN6 NIOSH Pub 2010-133sp How to don and doff #PPE\",\"object\":{\"objectType\":\"note\",\"id\":\"object:search.twitter.com,2005:740506753335451648\",\"summary\":\"Ponerse y Quitarse Adecuadamente un #Respirador Desechable https://t.co/WFnvmG7mN6 NIOSH Pub 2010-133sp How to don and doff #PPE\",\"link\":\"http://twitter.com/NPPTL/statuses/740506753335451648\",\"postedTime\":\"2016-06-08T11:32:22.000Z\"},\"favoritesCount\":0,\"twitter_entities\":{\"hashtags\":[{\"text\":\"Respirador\",\"indices\":[41,52]},{\"text\":\"PPE\",\"indices\":[129,133]}],\"urls\":[{\"url\":\"https://t.co/WFnvmG7mN6\",\"expanded_url\":\"http://go.usa.gov/gRFG\",\"display_url\":\"go.usa.gov/gRFG\",\"indices\":[64,87]}],\"user_mentions\":[],\"symbols\":[]},\"twitter_filter_level\":\"low\",\"twitter_lang\":\"es\"},\"favoritesCount\":0,\"twitter_entities\":{\"hashtags\":[{\"text\":\"Respirador\",\"indices\":[52,63]},{\"text\":\"PPE\",\"indices\":[139,140]}],\"urls\":[{\"url\":\"https://t.co/WFnvmG7mN6\",\"expanded_url\":\"http://go.usa.gov/gRFG\",\"display_url\":\"go.usa.gov/gRFG\",\"indices\":[75,98]}],\"user_mentions\":[{\"screen_name\":\"NPPTL\",\"name\":\"ProtectiveTechnology\",\"id\":18139029,\"id_str\":\"18139029\",\"indices\":[3,9]}],\"symbols\":[]},\"twitter_filter_level\":\"low\",\"twitter_lang\":\"es\",\"retweetCount\":1,\"gnip\":{\"matching_rules\":[{\"value\":\"url_contains:\\\"//www.cdc.gov/\\\"\",\"tag\":null}],\"urls\":[{\"url\":\"https://t.co/WFnvmG7mN6\",\"expanded_url\":\"http://www.cdc.gov/spanish/niosh/docs/2010-133_sp/pdfs/2010-133_sp.pdf\",\"expanded_status\":200}],\"language\":{\"value\":\"es\"},\"profileLocations\":[{\"objectType\":\"place\",\"geo\":{\"type\":\"point\",\"coordinates\":[-81.69541,41.4995]},\"address\":{\"country\":\"United States\",\"countryCode\":\"US\",\"locality\":\"Cleveland\",\"region\":\"Ohio\",\"subRegion\":\"Cuyahoga County\"},\"displayName\":\"Cleveland, Ohio, United States\"}]}}")

(deftest correct-parsing
  (testing "Input can be parsed correctly."
    (is (= (#'stream/parse-entry input-sample)
           {"tweetId" "tag:search.twitter.com,2005:740507302185336832",
            "postedTime" "2016-06-08T11:34:33.000Z",
            "postedDate" "2016-06-08",
            "body" "RT @NPPTL: Ponerse y Quitarse Adecuadamente un #Respirador Desechable https://t.co/WFnvmG7mN6 NIOSH Pub 2010-133sp How to don and doff",
            "urls" ["http://www.cdc.gov/spanish/niosh/docs/2010-133_sp/pdfs/2010-133_sp.pdf"]
            "matchingRules" ["url_contains:\"//www.cdc.gov/\""]}))))